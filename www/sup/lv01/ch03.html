<!DOCTYPE html><html><head><title>p_Программирование игровой логики</title><link rel="shortcut icon" href="/favicon.gif"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/style.css"></head></html><body class="artcl"><div class="artcl__back"></div><div class="artcl__overlay artcl__overlay--game"></div><aside class="sidebar"><div class="top-bar"><div class="top-bar__left"><a href="/sup" class="logo logo--game">p<span class="logo__slug">sup</span></a></div><div class="top-bar__right top-bar__right--pages"><a href="#" class="top-bar__link side-toggle-close">esc</a></div></div><ul class="menu menu--game menu--header"><li class="menu__item"><a href="index" class="menu__link"><span class="menu__slug">lv01</span><h1 class="menu__name">Пин-Понг</h1></a></li></ul><p class="sidebar__desc">Знакомимся с движком, языком TypeScript и создаем свою первую игру на Superpowers!</p><ul class="menu menu--game"><li class="menu__item"><a href="ch01" class="menu__link"><span class="menu__slug">ch01</span><p class="menu__name">Введение и План игры</p></a></li><li class="menu__item"><a href="ch02" class="menu__link"><span class="menu__slug">ch02</span><p class="menu__name">Подготовка Superpowers</p></a></li><li class="menu__item"><a href="ch03" class="menu__link menu--active"><span class="menu__slug">ch03</span><p class="menu__name">Программирование игровой логики</p></a></li><li class="menu__item"><a href="ch04" class="menu__link"><span class="menu__slug">ch04</span><p class="menu__name">Полировка игры</p></a></li><li class="menu__item"><a href="ch05" class="menu__link"><span class="menu__slug">ch05</span><p class="menu__name">Код готовой игры</p></a></li></ul></aside><div class="top-bar"><div class="top-bar__left"><a href="/sup" class="logo logo--game-artcl">p<span class="logo__slug">Superpowers</span></a></div><div class="top-bar__right top-bar__right--artcl"><span class="top-bar__path">sup / lv01 / ch03</span></div></div><div class="artcl-menu"><div class="artcl-menu__top"><ul class="menu menu--game menu--artcl"><li class="menu__item"><a href="#" class="menu__link artcl-menu-toc-toggle"><span class="menu__slug">-toc</span><p class="menu__name">Содержание</p></a></li><li class="menu__item"><a href="/sup" class="menu__link"><span class="menu__slug">home</span><p class="menu__name">Другие курсы</p></a></li><li class="menu__item"><a href="https://github.com/pajamhub/dev/edit/master/public/sup/lv01/ch03.md" class="menu__link"><span class="menu__slug">@git</span><p class="menu__name">GitHub</p></a></li></ul><p class="artcl-menu__edit">Если вы знаете, как сделать эту статью лучше, можете изменить её на GitHub! Мы рады любой помощи!</p></div><div class="artcl-menu__bottom"><ul class="menu menu--game menu--artcl"><li class="menu__item artcl-menu-top"><a href="#" class="menu__link artcl-menu-top-toggle"> <span class="menu__slug">^top</span><p class="menu__name">Вверх</p></a></li></ul></div></div><main class="artcl__text artcl__text--game"><h1>Программирование игровой логики</h1><h2>Введение</h2><p>Если вы ничего не знаете о программировании на Javascript (на котором основан TypeScript), вам стоит прочитать какой-нибудь учебник, чтобы иметь небольшое представление об этом (например <a href="https://learn.javascript.ru/">этот</a>). Не волнуйтесь, программирование это не так сложно, как вы могли себе представлять, в основном вам нужно научится решать реальные логические проблемы, главное не спешить и постепенно усвоить основные понятия. Вам может показаться, что это работает медленно и абстрактно даже для простых вещей. Но постепенно практикуясь, вы будете решать задачи быстрее и правильнее. (Часто, разочарование приходит, когда мы пытаемся выполнить задачу, к которой не готовы.)</p>
<p>Однако, вы можете продолжить урок и попытаться понять основы, просто копируя код в Superpowers. Повторяя и практикуясь, изучая и тестируя, делая ошибки и исправляя их (это мы называем отладкой, фундаментальное понятие в программировании, где ошибки нужно не избегать, а понимать) медленно, но уверенно вы будете делать удивительные успехи.</p>
<h2>Программирование поведение ракеток</h2><p>Теперь мы можем начать программировать логику нашей игры, начнем реализовывать движение ракеток.</p>
<p>В папке GameScripts <em>(Скрипты Игры)</em>, откроем скрипт Paddles <em>(Ракетки)</em>. Вы увидите стандартный скрипт, удаляем все и вместо этого пишем следующий шаблон:</p>
<pre><code class="language-ts">class Paddle1Behavior extends Sup.Behavior {

  update() {

  }
}

class Paddle2Behavior extends Sup.Behavior {

  update() {

  }
}

Sup.registerBehavior(Paddle1Behavior);
Sup.registerBehavior(Paddle2Behavior);
</code></pre>
<p>Мы будем работать в первом классе <em>(Class)</em> <code>Paddle1Behavior</code>, второй класс <code>Paddle2Behavior</code> будет почти таким же.</p>
<p>Определим переменные для класса, <code>pad</code> <em>(ракетка)</em> будет привязана в телу в нашей сцене и number <em>(число)</em> <code>speed</code> <em>(скорость)</em>. Пишем под строкой класса:</p>
<pre><code class="language-ts">class Paddle1Behavior extends Sup.Behavior {
    // присоединяем тело ракетки к переменной, которая будет часто использоваться в скрипте
    pad = this.actor.arcadeBody2D;
    // устанавливаем скорость ракетки
    speed : number = 0.1;
[...]
</code></pre>
<p>Мы будем использовать условие <code>if</code> <em>(если)</em> и команду <code>Sup.Input</code>, которая играет важную роль в Superpowers, так как позволяет получить пользовательский ввод, чтобы игрок мог управлять игрой используя мышь, клавиатуру, геймпад или свои пальцы на мобильных устройствах.</p>
<p>Нам нужна возможность приказать телу спрайта двигаться, если нажата клавиша на клавиатуре. Для этого используется команда <code>setVelocityY</code> (потому что мы будем двигать ракетку только по оси <strong>Y</strong>).</p>
<p>Также нужно проверять не вышла ли ракетка за экран, для этого нужно ограничить максимум и минимум, до которых ракетка может передвигаться вверх и вниз. Чтобы это реализовать, нужно отслеживать Y положение ракетки и добавить в условия возможность перемещать ракетку только тогда, когда она ниже максимального и выше минимального значения Y.</p>
<p>В метод <code>update</code> <em>(обновление)</em> добавим следующий скрипт:</p>
<pre><code class="language-ts">[...]
update() {

    // получаем Y позицию ракетки в переменную
    let y : number = this.actor.getY() ;

    // если нажата клавиша W и y &lt; максимума, направленная скорость тела
    // устанавливается на значение переменной скорости
    if(Sup.Input.isKeyDown(&quot;W&quot;) &amp;&amp; y &lt; 2.35){
      this.pad.setVelocityY(this.speed);
    }
    // если нажата клавиша S и y &gt; минимума, направленная скорость тела
    // устанавливается на отрицательное значение скорости
    else if(Sup.Input.isKeyDown(&quot;S&quot;) &amp;&amp; y &gt; -2.35){
      this.pad.setVelocityY(-this.speed);
    }
    // в других случаях скорость тела устанавливается на 0
    else{
      this.pad.setVelocityY(0);
    }

  }
[…]
</code></pre>
<p>Чтобы проверить скрипт, нужно прикрепить его к Актеру в Сцене. Для ракетки первого игрока создаем новый компонент <strong>Behavior</strong> <em>(Поведение)</em> и выбираем класс <code>Paddle1Behavior</code>.</p>
<p><img src="https://github.com/mseyne/superpowers-tutorials/raw/master/1SuperPong/img/behavior.png" alt="behavior.png"></p>
<p>Теперь запустим нашу программу и видим, что ракетка двигается вверх и вниз при нажатии клавиш W и S.</p>
<p>Для второй ракетки, скопируем этот код в класс <code>Paddle2Behavior</code>, но в <code>Sup.Input.isKeyDown</code> заменим
W и S на &#39;UP&#39; и &#39;DOWN&#39;.</p>
<p>Также как и с первой ракеткой, прикрепим скрипт к ракетке второго игрока
(new component&gt;Behavior) <em>(создать компонент&gt;Поведение)</em>, но выберем класс <code>Paddle2Behavior</code>.</p>
<h2>Программирование поведения мяча</h2><p>Начнем программировать перемещение мяча в ассета скрипт Ball из папки
GameScripts. Этот Скрипт будет больше, чем скрипт ракеток, потому что мы будем прописывать столкновения и систему очков внутри одного класса.</p>
<p>Удалим из стандартного шаблона метод <code>start</code>, в этой игре он не понадобится. Начальный скрипт должен выглядеть так:</p>
<pre><code class="language-ts">class BallBehavior extends Sup.Behavior {

  update() {

  }
}
Sup.registerBehavior(BallBehavior);
</code></pre>
<p>Поскольку у мяча будет ускорение, добавим скорость по умолчанию в виде константы, на которую мы будем ссылаться. вынесем константу из основного класса, для этой игры это не имеет значения, но в других играх, такую константу мы сможем использовать в других классах игры. Это хорошая практика, к которой стоит привыкнуть.</p>
<pre><code class="language-ts">const BALLSPEED : number = 0.05 ;
class BallBehavior extends Sup.Behavior {
[…]
</code></pre>
<p>Теперь добавим переменные в классе BallBehavior, одна для скорости мяча, которая будет увеличиваться начиная от нашей константы <code>BALLSPEED</code>, один <code>array</code> <em>(массив)</em> содержащий счет для <code>player1</code> и <code>player2</code>. И две переменные, которые будут положительными или отрицательными и задавать направление движения мяча. Например, если мяч движется вверх и ударяется об верхний край стола, переменная примет противоположное значение, говоря нам,
что мяч начал двигаться в противоположном направлении.</p>
<pre><code class="language-ts">[…]
class BallBehavior extends Sup.Behavior {
    // переменная скорости
    speed : number = BALLSPEED;
    // Присоединяем тело актера к переменной
    ball = this.actor.arcadeBody2D;
    // Массив с score[0] для player 1 и score[1] для player 2
    score = [0, 0];
    // устанавливаем положительные или отрицательные
    // переменные направления для x и y
    dx : number = 1; dy : number = 1;
[…]
</code></pre>
<p>Напишем несколько условий для разных случаев:</p>
<ol>
<li><p>Если мяч касается верхней или нижней стороны стола, он меняет направление по оси Y и продолжает двигаться в туже сторону по оси X. Просто проверяем состояние и если это истинно, меняем переменную <code>dy</code>.</p>
</li>
<li><p>Если мяч сталкивается с ракетками, он получает небольшое ускорение и начинает двигаться в противоположном направлении по оси X, а направление оси Y остается прежним (мяч должен столкнутся с левой или правой стороной ракетки). Используем метод <code>Sup.ArcadePhysics2D.collides</code>, чтобы проверить столкнулось ли Физическое Тело мяча с ракетками. И еще проверка стороны столкновения мяча с помощью метода <code>getTouches</code>.</p>
</li>
<li><p>Если мяч коснется левой или правой стороны стола (когда ракетка не ловит его), увеличивается счет игрока, который забил этот гол (мы сделаем это чуть позже). Мяч возвращается в центр и возвращается к стандартной скорости.</p>
</li>
</ol>
<p>Хорошо, теперь напишем поведение мяча внутри цикла метода <code>update</code>.</p>
<pre><code class="language-ts">[…]
  update() {

    // получаем позицию мяча по x и y

    let x : number  = this.actor.getX(); let y : number  = this.actor.getY();

    // меняем направление мяча по y, если он достиг верхней или нижней стороны

    if(y &gt; 2.85 || y &lt; -2.85){
      this.dy = this.dy * -1;
    }

    // Проверяем, есть ли столкновение между мячом и ракеткой

    if(Sup.ArcadePhysics2D.collides(this.ball, Sup.ArcadePhysics2D.getAllBodies())){

      /* Если есть столкновение, проверяем мячь столкнулся
      с ракеткой левой/правой (меняем направление x) или
      верхней/нижней стороной (направление y),
      и немного увеличиваем скорость мяча. */

      if(this.ball.getTouches().right || this.ball.getTouches().left){
        this.dx = this.dx * -1;
        this.speed += 0.01
        }
      else {
        this.dy = this.dy * -1;
        }

      }

    /* Проверяем, прошел ли мячь мимо ракетки и вышел ли за
    пределы экрана (с левой или правой стороны стола).
    Если да, перемещаем мяч в центр, меняем направление
    по оси X и возвращаем скорости начальное значение. */

    if(x &gt; 4 || x &lt; -4){
       this.ball.warpPosition(0, 0);
       this.dx = this.dx * -1;
       this.speed = BALLSPEED;
       }

    // устанавливаем направленную скорость мяча (скорость*направление)
    // для осей Y и X (мяч всегда должен быть в движении)

    this.ball.setVelocity(this.speed*this.dx, this.speed*this.dy);

  }
[…]
</code></pre>
<p>Чтобы увидеть скрипт в действии, мы должны, как ранее, прикрепить его к Актеру Ball в сцене Game. (new component&gt;behavior, class = BallBehavior)</p>
<p>Теперь игра должна работать.</p>
<h2>Система очков</h2><p>Теперь добавим простую систему очков. Нам нужно, чтобы, когда противник пропускает мячь, счет игрока увеличивается на один.</p>
<p>Для этого, добавим два условия в конце класса BallBehavior, одно для случая когда мяч коснулся стороны первого игрока и один для стороны второго игрока.</p>
<p>Используем метод <code>textRenderer</code>, чтобы изменять отображение счета, к нему прикрепим метод <code>getActor(&#39;Player1&#39;).getChild(&#39;Score&#39;)</code> для очков первого игрока и <code>getActor(&#39;Player2&#39;).getChild(&#39;Score&#39;)</code> для очков второго.</p>
<pre><code class="language-ts">[...]
    //Меняем счет в зависимости от того, с какой стороны прошел мяч по оси X
    if(x &gt; 4){
      ++this.score[0];
      Sup.getActor(&quot;Player1&quot;).getChild(&quot;Score&quot;).textRenderer.setText(this.score[0]);
    }

    if(x &lt; -4){
      ++this.score[1];
      Sup.getActor(&quot;Player2&quot;).getChild(&quot;Score&quot;).textRenderer.setText(this.score[1]);
    }

    // устанавливаем направленную скорость мяча (скорость*направление)
    // для осей Y и X (мячь всегда должен быть в движении)
    this.ball.setVelocity(this.speed*this.dx, this.speed*this.dy);
  }
}
Sup.registerBehavior(BallBehavior);
</code></pre>
<p>Мы закончили игровую логику. Нужно сделать еще пару вещей, чтобы выпустить игру, но уже сейчас в нее можно играть.</p></main><div class="footer footer--artcl"><div class="footer__license"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" class="footer__license-link"><img alt="Лицензия Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" class="footer__license-img"/></a></div><div class="footer__social"><ul class="footer__social-list"><li class="footer__social-item"><a href="https://vk.com/pajam" title="vk.com" class="footer__social-link">vk</a></li><li class="footer__social-item"><a href="https://twitter.com/pajam_tw" title="twitter" class="footer__social-link">tw</a></li><li class="footer__social-item"><a href="https://pajam.tumblr.com/" title="tumblr" class="footer__social-link">tu</a></li></ul></div></div><div class="bottom-bar"><ul class="menu menu--game menu--artcl"><li class="menu__item"><a href="#" class="menu__link bottom-bar-toc-toggle"><span class="menu__slug">-toc</span><p class="menu__name">Содержание</p></a></li></ul></div><script type="text/javascript" src="../../js/sidebar.js"></script><script type="text/javascript" src="../../js/top.js"></script><script type="text/javascript" src="../../js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></body>